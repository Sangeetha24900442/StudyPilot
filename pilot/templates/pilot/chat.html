<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StudyPilot Chatbot ü§ñ</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        height: 100vh;
        margin: 0;
        padding: 20px;
    }

    h2 {
        color: #333;
    }

    #chat-container {
        background: #fff;
        width: 100%;
        max-width: 600px;
        height: 70vh;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .message {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 20px;
        word-wrap: break-word;
    }

    .user {
        align-self: flex-end;
        background: #007bff;
        color: white;
        border-bottom-right-radius: 0;
    }

    .bot {
        align-self: flex-start;
        background: #e4e6eb;
        color: #333;
        border-bottom-left-radius: 0;
    }

    #input-container {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        width: 100%;
        max-width: 600px;
    }

    #msg {
        flex: 1;
        padding: 10px;
        border-radius: 20px;
        border: 1px solid #ccc;
        font-size: 16px;
    }

    #sendBtn, #voiceBtn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
    }

    #sendBtn:hover, #voiceBtn:hover {
        background: #0056b3;
    }
</style>
</head>
<body>

<h2>StudyPilot Chatbot ü§ñ</h2>

<div id="chat-container"></div>

<div id="input-container">
    <input id="msg" placeholder="Type your message..." />
    <button id="voiceBtn">üé§</button>
    <button id="sendBtn">‚û°Ô∏è</button>
</div>

<script>
const chatContainer = document.getElementById('chat-container');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('sendBtn');
const voiceBtn = document.getElementById('voiceBtn');

// ======== Voice Recognition Setup ========
let recognition;
if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        msgInput.value = transcript;
        sendMessage();
    };

    recognition.onerror = function(event) {
        console.error(event.error);
    };
} else {
    voiceBtn.disabled = true;
    voiceBtn.title = "Voice not supported in this browser";
}

// Start voice recording
voiceBtn.addEventListener('click', () => {
    if (recognition) recognition.start();
});

// ======== Text-to-Speech ========
function speak(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.pitch = 1;
    utterance.rate = 1;
    speechSynthesis.speak(utterance);
}

// ======== Add Message to Chat ========
function addMessage(text, sender) {
    const div = document.createElement('div');
    div.classList.add('message', sender);
    div.innerText = text;
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// ======== Send Message ========
function sendMessage() {
    const message = msgInput.value.trim();
    if (!message) return;

    addMessage(message, 'user');
    msgInput.value = '';

    const loadingDiv = document.createElement('div');
    loadingDiv.classList.add('message', 'bot');
    loadingDiv.innerText = '...';
    chatContainer.appendChild(loadingDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    fetch('/chatbot/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
    })
    .then(res => res.json())
    .then(data => {
        chatContainer.removeChild(loadingDiv);
        const reply = data.reply || "No response from bot";
        addMessage(reply, 'bot');
        speak(reply);
    })
    .catch(err => {
        chatContainer.removeChild(loadingDiv);
        addMessage("Error connecting to bot", 'bot');
        console.error(err);
    });
}

// ======== Event Listeners ========
sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});
</script>

</body>
</html>